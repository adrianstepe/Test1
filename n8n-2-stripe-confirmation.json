{
    "nodes": [
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "stripe-confirmation-webhook",
                "options": {}
            },
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 2,
            "position": [
                32,
                -64
            ],
            "id": "4ff840a4-1c71-49a4-863b-793edd5b97e3",
            "name": "Webhook",
            "webhookId": "45c1830b-9364-4b68-9c7d-e8ea2dade456"
        },
        {
            "parameters": {
                "dataType": "string",
                "value1": "={{$json.body.type}}",
                "rules": {
                    "rules": [
                        {
                            "value2": "checkout.session.completed"
                        }
                    ]
                }
            },
            "name": "Event Type Filter",
            "type": "n8n-nodes-base.switch",
            "typeVersion": 1,
            "position": [
                240,
                -64
            ],
            "id": "a07c1749-f2c2-450a-82cc-4b5980ac7764"
        },
        {
            "parameters": {
                "jsCode": "// Robust Data Extraction\n// This prevents crashes and guarantees an email string exists\n\nconst item = $input.first();\nconst body = item.json.body;\n\n// Safely access nested objects (returns undefined instead of crashing)\nconst dataObject = body?.data?.object || {};\nconst metadata = dataObject.metadata || {};\nconst customerDetails = dataObject.customer_details || {};\n\n// 1. Determine Name\nconst customerName = customerDetails.name || metadata.customer_name || 'Valued Patient';\n\n// 2. Determine Email (With Safety Fallback)\n// If no email is found, we use a placeholder to prevent the Gmail node from throwing \"Bad Request\"\nlet customerEmail = customerDetails.email || metadata.customer_email;\nif (!customerEmail) {\n  customerEmail = 'no-email-found@error.com'; // Fallback to allow debugging\n}\n\n// 3. Amount\nconst amountPaid = ((dataObject.amount_total || 0) / 100).toFixed(2);\n\nreturn [{\n  customer_name: customerName,\n  customer_email: customerEmail,\n  booking_date: metadata.booking_date || 'N/A',\n  booking_time: metadata.booking_time || 'N/A',\n  service_id: metadata.service_id,\n  amount_paid: amountPaid,\n  payment_status: dataObject.payment_status\n}];"
            },
            "name": "Extract Booking Data",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                432,
                -64
            ],
            "id": "be4dcbbe-9967-4df1-a9ec-0e922b74faf7"
        },
        {
            "parameters": {
                "sendTo": "={{$json.customer_email}}",
                "subject": "‚úÖ Appointment Confirmed - Butkeviƒça Dental",
                "emailType": "text",
                "message": "=Hi {{$json.customer_name}},\n\nThank you for your payment of ‚Ç¨{{$json.amount_paid}}!\n\nYour dental appointment is confirmed:\nüìÖ Date: {{$json.booking_date}}\n‚è∞ Time: {{$json.booking_time}}\n\nWe look forward to seeing you!\n\nIf you need to reschedule or have any questions, please contact us.\n\nBest regards,\nButkeviƒça Dental Practice\n\n---\nThis is an automated confirmation email.",
                "options": {}
            },
            "name": "Send Confirmation Email",
            "type": "n8n-nodes-base.gmail",
            "typeVersion": 2.1,
            "position": [
                640,
                -64
            ],
            "id": "aac16f8b-af35-48b3-b429-07ab974b1909",
            "webhookId": "b0276529-77fc-4b38-abf8-4401acef7bc4",
            "credentials": {
                "gmailOAuth2": {
                    "id": "bsHsQyITlAn3DBQk",
                    "name": "Gmail account"
                }
            }
        }
    ],
    "connections": {
        "Webhook": {
            "main": [
                [
                    {
                        "node": "Event Type Filter",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Event Type Filter": {
            "main": [
                [
                    {
                        "node": "Extract Booking Data",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Extract Booking Data": {
            "main": [
                [
                    {
                        "node": "Send Confirmation Email",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "pinData": {},
    "meta": {
        "templateCredsSetupCompleted": true,
        "instanceId": "edb1e678c20bb2dc211861028fa5a0da62086103c19f921423bcdc604ef1f332"
    }
}