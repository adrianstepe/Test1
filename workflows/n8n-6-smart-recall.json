{
    "name": "System - Smart Recall",
    "nodes": [
        {
            "parameters": {
                "rule": {
                    "interval": [
                        {
                            "triggerAtHour": 9
                        }
                    ]
                }
            },
            "id": "schedule-trigger",
            "name": "Daily 9AM Trigger",
            "type": "n8n-nodes-base.scheduleTrigger",
            "typeVersion": 1.2,
            "position": [
                -200,
                0
            ],
            "notes": "Runs every day at 9:00 AM Europe/Riga time"
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "WITH last_appointments AS (\n  SELECT \n    b.customer_email,\n    b.customer_name,\n    b.phone,\n    CASE \n      WHEN b.phone IS NULL OR b.phone = '' THEN 'lv'\n      WHEN b.phone LIKE '+371%' THEN 'lv'\n      WHEN b.phone LIKE '371%' THEN 'lv'\n      WHEN LENGTH(REGEXP_REPLACE(b.phone, '[^0-9]', '', 'g')) = 8 THEN 'lv'\n      ELSE 'en'\n    END AS language_preference,\n    MAX(b.start_time) AS last_appointment_date\n  FROM bookings b\n  WHERE b.status IN ('completed', 'confirmed')\n    AND b.start_time < NOW()\n  GROUP BY b.customer_email, b.customer_name, b.phone\n),\npatients_with_future_appointments AS (\n  SELECT DISTINCT customer_email\n  FROM bookings\n  WHERE status IN ('confirmed', 'pending')\n    AND start_time > NOW()\n)\nSELECT \n  la.customer_email AS patient_email,\n  la.customer_name AS patient_name,\n  la.language_preference\nFROM last_appointments la\nWHERE \n  la.last_appointment_date >= NOW() - INTERVAL '6 months' - INTERVAL '7 days'\n  AND la.last_appointment_date <= NOW() - INTERVAL '6 months' + INTERVAL '7 days'\n  AND la.customer_email NOT IN (SELECT customer_email FROM patients_with_future_appointments)\nORDER BY la.last_appointment_date ASC;",
                "options": {}
            },
            "id": "fetch-recall-patients",
            "name": "Fetch Recall Patients",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                50,
                0
            ],
            "credentials": {
                "postgres": {
                    "id": "GuG495s0j2amZHOv",
                    "name": "Postgres account 2"
                }
            },
            "onError": "stopWorkflow"
        },
        {
            "parameters": {
                "batchSize": 10,
                "options": {}
            },
            "id": "batch-processor",
            "name": "Split In Batches",
            "type": "n8n-nodes-base.splitInBatches",
            "typeVersion": 3,
            "position": [
                300,
                0
            ]
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": false,
                        "leftValue": "",
                        "typeValidation": "loose"
                    },
                    "conditions": [
                        {
                            "id": "latvian-check",
                            "leftValue": "={{ $json.language_preference }}",
                            "rightValue": "lv",
                            "operator": {
                                "type": "string",
                                "operation": "equals"
                            }
                        }
                    ],
                    "combinator": "or"
                }
            },
            "id": "language-switch",
            "name": "Check Language",
            "type": "n8n-nodes-base.if",
            "typeVersion": 2,
            "position": [
                550,
                0
            ]
        },
        {
            "parameters": {
                "sendTo": "={{ $json.patient_email }}",
                "subject": "AtgÄdinÄjums: JÅ«su 6 mÄ“neÅ¡u smaida pÄrbaude",
                "emailType": "html",
                "message": "<p>Sveiki, {{ $json.patient_name }}!</p>\n\n<p>Ir pagÄjuÅ¡i 6 mÄ“neÅ¡i kopÅ¡ JÅ«su pÄ“dÄ“jÄs vizÄ«tes. Lai smaids bÅ«tu vesels, Ärsti rekomendÄ“ veikt pÄrbaudi un higiÄ“nu reizi pusgadÄ.</p>\n\n<p>MÄ“s labprÄt JÅ«s pierakstÄ«tu uz vizÄ«ti nÄkamajÄ mÄ“nesÄ«.</p>\n\n<p>ğŸ“… <b>RezervÄ“jiet sev Ä“rtu laiku Å¡eit:</b> <a href=\"https://butkevica-dental-booking.pages.dev\">Pieteikt VizÄ«ti</a></p>\n\n<p>Uz drÄ«zu tikÅ¡anos,<br>\nButkeviÄa Dental Practice</p>",
                "options": {}
            },
            "id": "send-latvian-email",
            "name": "Send Latvian Email",
            "type": "n8n-nodes-base.gmail",
            "typeVersion": 2.1,
            "position": [
                800,
                -100
            ],
            "credentials": {
                "gmailOAuth2": {
                    "id": "bsHsQyITlAn3DBQk",
                    "name": "Gmail account"
                }
            },
            "onError": "stopWorkflow"
        },
        {
            "parameters": {
                "sendTo": "={{ $json.patient_email }}",
                "subject": "Reminder: Your 6-Month Dental Checkup",
                "emailType": "html",
                "message": "<p>Hello, {{ $json.patient_name }}!</p>\n\n<p>It's been 6 months since your last visit. Dentists recommend a checkup and hygiene appointment every 6 months for optimal oral health.</p>\n\n<p>We'd love to schedule your next appointment!</p>\n\n<p>ğŸ“… <b>Book your convenient time here:</b> <a href=\"https://butkevica-dental-booking.pages.dev\">Book Appointment</a></p>\n\n<p>Looking forward to seeing you,<br>\nButkeviÄa Dental Practice</p>",
                "options": {}
            },
            "id": "send-english-email",
            "name": "Send English Email",
            "type": "n8n-nodes-base.gmail",
            "typeVersion": 2.1,
            "position": [
                800,
                100
            ],
            "credentials": {
                "gmailOAuth2": {
                    "id": "bsHsQyITlAn3DBQk",
                    "name": "Gmail account"
                }
            },
            "onError": "stopWorkflow"
        },
        {
            "parameters": {},
            "id": "merge-results",
            "name": "Merge Results",
            "type": "n8n-nodes-base.merge",
            "typeVersion": 3,
            "position": [
                1050,
                0
            ]
        }
    ],
    "connections": {
        "Daily 9AM Trigger": {
            "main": [
                [
                    {
                        "node": "Fetch Recall Patients",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Fetch Recall Patients": {
            "main": [
                [
                    {
                        "node": "Split In Batches",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Split In Batches": {
            "main": [
                [
                    {
                        "node": "Check Language",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Check Language": {
            "main": [
                [
                    {
                        "node": "Send Latvian Email",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Send English Email",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Send Latvian Email": {
            "main": [
                [
                    {
                        "node": "Merge Results",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Send English Email": {
            "main": [
                [
                    {
                        "node": "Merge Results",
                        "type": "main",
                        "index": 1
                    }
                ]
            ]
        }
    },
    "pinData": {},
    "meta": {
        "templateCredsSetupCompleted": true,
        "instanceId": "edb1e678c20bb2dc211861028fa5a0da62086103c19f921423bcdc604ef1f332"
    },
    "settings": {
        "executionOrder": "v1",
        "timezone": "Europe/Riga"
    }
}