{
    "name": "Google Review Request (3h Post-Appointment)",
    "nodes": [
        {
            "parameters": {
                "triggerTimes": {
                    "item": [
                        {
                            "mode": "everyX",
                            "value": 30,
                            "unit": "minutes"
                        }
                    ]
                }
            },
            "name": "Cron (Every 30m)",
            "type": "n8n-nodes-base.cron",
            "typeVersion": 1,
            "position": [
                0,
                0
            ],
            "id": "cron-trigger"
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "SELECT * FROM bookings \nWHERE status = 'confirmed' \nAND end_time >= NOW() - INTERVAL '3 hours 30 minutes' \nAND end_time < NOW() - INTERVAL '3 hours';",
                "additionalFields": {}
            },
            "name": "Fetch Recent Appointments",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                200,
                0
            ],
            "id": "fetch-recent",
            "credentials": {
                "postgres": {
                    "id": "GuG495s0j2amZHOv",
                    "name": "Postgres account 2"
                }
            }
        },
        {
            "parameters": {
                "batchSize": 1,
                "options": {}
            },
            "name": "Split Batches",
            "type": "n8n-nodes-base.splitInBatches",
            "typeVersion": 1,
            "position": [
                400,
                0
            ],
            "id": "split-batches"
        },
        {
            "parameters": {
                "jsCode": "// Multi-language Logic for Google Review Request\nconst booking = $input.first().json;\nconst phone = (booking.phone || '').replace(/\\D/g, ''); // Remove non-digits\nconst name = booking.customer_name || 'Patient';\n\n// Language Rule: Default to Latvian. Only switch to English if phone is foreign.\n// Latvian phones start with 371 or are 8 digits long (local format).\nconst isLatvian = !phone || phone.startsWith('371') || phone.length === 8;\nconst lang = isLatvian ? 'lv' : 'en';\n\nconst reviewLink = 'https://search.google.com/local/writereview?placeid=ChIJPT-F_87P7kYRZvLaa9hzpn0';\n\nlet emailSubject, emailBody;\n\n// --- LATVIAN (Default) ---\nif (lang === 'lv') {\n  emailSubject = `Labdien, ${name}!`;\n  emailBody = `Labdien, ${name}!\n\nPaldies, ka Å¡odien uzticÄ“jÄt savu smaidu Dr. ButkeviÄas klÄ«nikai.\n\nMÄ“s Å¡obrÄ«d aktÄ«vi strÄdÄjam pie tÄ, lai nodroÅ¡inÄtu visaugstÄko servisa lÄ«meni katram pacientam, tÄpÄ“c JÅ«su viedoklis mums ir Ä¼oti svarÄ«gs.\n\nðŸŒŸ **Ja esat apmierinÄts ar vizÄ«ti:**\nBÅ«sim no sirds pateicÄ«gi, ja veltÄ«siet brÄ«di, lai atstÄtu atsauksmi Google. Tas mums Ä¼oti palÄ«dz:\n${reviewLink}\n\nðŸ’¬ **Ja ir kas tÄds, ko mÄ“s varÄ“tu darÄ«t labÄk:**\nMÄ“s vÄ“lamies augt un mÄcÄ«ties. Ja kaut kas JÅ«s neapmierinÄja vai palika neskaidrs, lÅ«dzu, atbildiet uz Å¡o e-pastu un pastÄstiet mums. MÄ“s to noteikti Å†emsim vÄ“rÄ un centÄ«simies situÄciju atrisinÄt.\n\nAr cieÅ†u,\nDr. ButkeviÄas prakses komanda`;\n}\n\n// --- ENGLISH (Foreign Phones) ---\nelse {\n  emailSubject = `Hello, ${name}!`;\n  emailBody = `Hello, ${name}!\n\nThank you for trusting your smile to Dr. ButkeviÄa's Clinic today.\n\nWe are actively working to ensure the highest level of service for every patient, so your feedback is very important to us.\n\nðŸŒŸ **If you are happy with your visit:**\nWe would be truly grateful if you could take a moment to leave a review on Google. It helps us a lot:\n${reviewLink}\n\nðŸ’¬ **If there is anything we could do better:**\nWe want to grow and learn. If anything was not up to your expectations or remained unclear, please reply to this email and tell us. We will definitely take it into account and try to resolve the situation.\n\nSincerely,\nDr. ButkeviÄa Practice Team`;\n}\n\nreturn {\n  json: {\n    ...booking,\n    email_subject: emailSubject,\n    email_body: emailBody\n  }\n};"
            },
            "name": "Language Logic",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                600,
                0
            ],
            "id": "language-logic"
        },
        {
            "parameters": {
                "sendTo": "={{$json.customer_email}}",
                "subject": "={{$json.email_subject}}",
                "message": "={{$json.email_body}}",
                "options": {}
            },
            "name": "Send Email (Gmail)",
            "type": "n8n-nodes-base.gmail",
            "typeVersion": 2.1,
            "position": [
                800,
                0
            ],
            "id": "send-email",
            "credentials": {
                "gmailOAuth2": {
                    "id": "bsHsQyITlAn3DBQk",
                    "name": "Gmail account"
                }
            }
        }
    ],
    "connections": {
        "Cron (Every 30m)": {
            "main": [
                [
                    {
                        "node": "Fetch Recent Appointments",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Fetch Recent Appointments": {
            "main": [
                [
                    {
                        "node": "Split Batches",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Split Batches": {
            "main": [
                [
                    {
                        "node": "Language Logic",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Language Logic": {
            "main": [
                [
                    {
                        "node": "Send Email (Gmail)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Send Email (Gmail)": {
            "main": [
                [
                    {
                        "node": "Split Batches",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    }
}