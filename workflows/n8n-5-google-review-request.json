{
    "name": "Google Review Request (3h Post-Appointment)",
    "nodes": [
        {
            "parameters": {
                "triggerTimes": {
                    "item": [
                        {
                            "mode": "everyX",
                            "value": 30,
                            "unit": "minutes"
                        }
                    ]
                }
            },
            "name": "Cron (Every 30m)",
            "type": "n8n-nodes-base.cron",
            "typeVersion": 1,
            "position": [
                0,
                0
            ],
            "id": "cron-trigger"
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "SELECT * FROM bookings \nWHERE status = 'confirmed' \nAND end_time >= NOW() - INTERVAL '3 hours 30 minutes' \nAND end_time < NOW() - INTERVAL '3 hours';",
                "additionalFields": {}
            },
            "name": "Fetch Recent Appointments",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                200,
                0
            ],
            "id": "fetch-recent",
            "credentials": {
                "postgres": {
                    "id": "GuG495s0j2amZHOv",
                    "name": "Postgres account 2"
                }
            }
        },
        {
            "parameters": {
                "batchSize": 1,
                "options": {}
            },
            "name": "Split Batches",
            "type": "n8n-nodes-base.splitInBatches",
            "typeVersion": 1,
            "position": [
                400,
                0
            ],
            "id": "split-batches"
        },
        {
            "parameters": {
                "jsCode": "// ========================\n// Multi-language Logic for Google Review Request\n// ========================\n\nconst booking = $input.first().json;\nconst phone = (booking.customer_phone || booking.phone || '').replace(/\\D/g, '');\nconst rawName = booking.customer_name || 'Pacient';\n\n// ========================\n// HELPER: Proper Case Name\n// ========================\nconst formatName = (str) => {\n  if (!str) return 'Pacient';\n  return str.replace(/\\w\\S*/g, (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());\n};\nconst name = formatName(rawName);\n\n// Language Rule: Default to Latvian. Only switch to English if phone is foreign.\n// Latvian phones start with 371 or are 8 digits long (local format).\nconst isLatvian = !phone || phone.startsWith('371') || phone.length === 8;\nconst lang = isLatvian ? 'lv' : 'en';\n\nconst reviewLink = 'https://search.google.com/local/writereview?placeid=ChIJPT-F_87P7kYRZvLaa9hzpn0';\n\nlet emailSubject, emailBody;\n\n// ========================\n// HTML EMAIL TEMPLATES\n// ========================\n\n// --- LATVIAN (Default) ---\nif (lang === 'lv') {\n  emailSubject = `Paldies par JÅ«su Å¡odienas vizÄ«ti! ğŸ¦·`;\n  emailBody = `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\\\"utf-8\\\">\n  <style>\n    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; background: #f8fafc; }\n    .header { background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); color: white; padding: 30px; border-radius: 12px 12px 0 0; text-align: center; }\n    .header h1 { margin: 0; font-size: 24px; }\n    .content { background: white; padding: 30px; border-radius: 0 0 12px 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }\n    .greeting { font-size: 18px; margin-bottom: 20px; }\n    .message { color: #475569; margin-bottom: 25px; }\n    .review-cta { text-align: center; margin: 30px 0; }\n    .review-btn { display: inline-block; background: linear-gradient(135deg, #f59e0b 0%, #eab308 100%); color: white !important; padding: 16px 40px; border-radius: 10px; text-decoration: none; font-weight: 700; font-size: 18px; box-shadow: 0 4px 15px rgba(245,158,11,0.4); }\n    .review-btn:hover { transform: translateY(-2px); }\n    .stars { font-size: 24px; margin-bottom: 10px; }\n    .feedback-section { background: #f1f5f9; padding: 20px; border-radius: 8px; margin-top: 25px; }\n    .feedback-section p { margin: 0; color: #64748b; }\n    .footer { text-align: center; margin-top: 30px; color: #94a3b8; font-size: 14px; }\n  </style>\n</head>\n<body>\n  <div class=\\\"header\\\">\n    <h1>ğŸ¦· Paldies par JÅ«su uzticÄ«bu!</h1>\n  </div>\n  <div class=\\\"content\\\">\n    <p class=\\\"greeting\\\">Labdien, <strong>${name}</strong>!</p>\n    \n    <p class=\\\"message\\\">Paldies, ka Å¡odien uzticÄ“jÄt savu smaidu Dr. ButkeviÄas klÄ«nikai. MÄ“s augstu vÄ“rtÄ“jam JÅ«su uzticÄ«bu.</p>\n    \n    <p class=\\\"message\\\">Vai esat apmierinÄts ar vizÄ«ti? BÅ«sim no sirds pateicÄ«gi, ja veltÄ«siet brÄ«di, lai atstÄtu atsauksmi Google.</p>\n    \n    <div class=\\\"review-cta\\\">\n      <div class=\\\"stars\\\">â­â­â­â­â­</div>\n      <a href=\\\"${reviewLink}\\\" class=\\\"review-btn\\\">AtstÄt Atsauksmi</a>\n    </div>\n    \n    <div class=\\\"feedback-section\\\">\n      <p>ğŸ’¬ <strong>Ja kaut kas nebija kÄrtÄ«bÄ</strong>, lÅ«dzu, atbildiet uz Å¡o e-pastu, un mÄ“s to atrisinÄsim.</p>\n    </div>\n    \n    <div class=\\\"footer\\\">\n      <p>Ar cieÅ†u,<br><strong>Dr. ButkeviÄas prakses komanda</strong></p>\n    </div>\n  </div>\n</body>\n</html>\n`;\n}\n\n// --- ENGLISH (Foreign Phones) ---\nelse {\n  emailSubject = `Thank you for your visit today! ğŸ¦·`;\n  emailBody = `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\\\"utf-8\\\">\n  <style>\n    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; background: #f8fafc; }\n    .header { background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); color: white; padding: 30px; border-radius: 12px 12px 0 0; text-align: center; }\n    .header h1 { margin: 0; font-size: 24px; }\n    .content { background: white; padding: 30px; border-radius: 0 0 12px 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }\n    .greeting { font-size: 18px; margin-bottom: 20px; }\n    .message { color: #475569; margin-bottom: 25px; }\n    .review-cta { text-align: center; margin: 30px 0; }\n    .review-btn { display: inline-block; background: linear-gradient(135deg, #f59e0b 0%, #eab308 100%); color: white !important; padding: 16px 40px; border-radius: 10px; text-decoration: none; font-weight: 700; font-size: 18px; box-shadow: 0 4px 15px rgba(245,158,11,0.4); }\n    .review-btn:hover { transform: translateY(-2px); }\n    .stars { font-size: 24px; margin-bottom: 10px; }\n    .feedback-section { background: #f1f5f9; padding: 20px; border-radius: 8px; margin-top: 25px; }\n    .feedback-section p { margin: 0; color: #64748b; }\n    .footer { text-align: center; margin-top: 30px; color: #94a3b8; font-size: 14px; }\n  </style>\n</head>\n<body>\n  <div class=\\\"header\\\">\n    <h1>ğŸ¦· Thank You for Your Trust!</h1>\n  </div>\n  <div class=\\\"content\\\">\n    <p class=\\\"greeting\\\">Hello, <strong>${name}</strong>!</p>\n    \n    <p class=\\\"message\\\">Thank you for trusting your smile to Dr. ButkeviÄa's Clinic today. We truly appreciate your trust.</p>\n    \n    <p class=\\\"message\\\">Are you satisfied with your visit? We would be truly grateful if you could take a moment to leave us a review on Google.</p>\n    \n    <div class=\\\"review-cta\\\">\n      <div class=\\\"stars\\\">â­â­â­â­â­</div>\n      <a href=\\\"${reviewLink}\\\" class=\\\"review-btn\\\">Leave a Review</a>\n    </div>\n    \n    <div class=\\\"feedback-section\\\">\n      <p>ğŸ’¬ <strong>If something wasn't right</strong>, please reply to this email and we'll make it right.</p>\n    </div>\n    \n    <div class=\\\"footer\\\">\n      <p>Best regards,<br><strong>Dr. ButkeviÄa Practice Team</strong></p>\n    </div>\n  </div>\n</body>\n</html>\n`;\n}\n\nreturn {\n  json: {\n    ...booking,\n    email_subject: emailSubject,\n    email_body: emailBody\n  }\n};"
            },
            "name": "Language Logic",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                600,
                0
            ],
            "id": "language-logic"
        },
        {
            "parameters": {
                "sendTo": "={{$json.customer_email}}",
                "subject": "={{$json.email_subject}}",
                "emailType": "html",
                "message": "={{$json.email_body}}",
                "options": {}
            },
            "name": "Send Email (Gmail)",
            "type": "n8n-nodes-base.gmail",
            "typeVersion": 2.1,
            "position": [
                800,
                0
            ],
            "id": "send-email",
            "credentials": {
                "gmailOAuth2": {
                    "id": "bsHsQyITlAn3DBQk",
                    "name": "Gmail account"
                }
            }
        }
    ],
    "connections": {
        "Cron (Every 30m)": {
            "main": [
                [
                    {
                        "node": "Fetch Recent Appointments",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Fetch Recent Appointments": {
            "main": [
                [
                    {
                        "node": "Split Batches",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Split Batches": {
            "main": [
                [
                    {
                        "node": "Language Logic",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Language Logic": {
            "main": [
                [
                    {
                        "node": "Send Email (Gmail)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Send Email (Gmail)": {
            "main": [
                [
                    {
                        "node": "Split Batches",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    }
}